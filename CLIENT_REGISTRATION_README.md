# Регистрация клиентов при создании заказов

## Описание процесса

Система автоматически создает учетные записи клиентов при создании заказов координатором. Это позволяет клиентам отслеживать свои заказы через личный кабинет.

## Алгоритм работы

### 1. Клиент отправляет заявку
- Клиент заполняет форму заявки на сайте
- Заявка сохраняется в таблице `applications`
- **Клиент НЕ создается на этом этапе**

### 2. Координатор просматривает заявку
- Координатор видит новую заявку в дашборде
- Может просмотреть детали заявки
- Решает создать заказ на основе заявки

### 3. Создание заказа
При создании заказа координатор может:

#### Вариант A: Выбрать существующего клиента
- Если клиент уже был в системе, координатор выбирает его из списка
- Заказ привязывается к существующему клиенту

#### Вариант B: Создать нового клиента (автоматически)
- Если передан `client_id: null`, система автоматически создаст клиента
- Используются данные из заявки:
  - Имя, фамилия, email, телефон
  - Адрес мероприятия как адрес клиента
  - Название компании из формы заказа
  - Категория клиента (corporate/one_time)

### 4. Отправка уведомлений

#### Для новых клиентов:
- **Email с учетными данными** отправляется автоматически
- Содержит: логин (email), сгенерированный пароль, ссылку на вход
- Дизайн письма: `resources/views/emails/client-account-created.blade.php`

#### Для разовых клиентов (one_time):
- Получают ссылку на оплату в личном кабинете
- Могут оплатить заказ онлайн

#### Для корпоративных клиентов (corporate):
- Заказ виден в личном кабинете
- Могут управлять заказом без оплаты онлайн

## API Endpoints

### Создание заказа из заявки
```
POST /api/applications/{application}/create-order
```

**Параметры:**
```json
{
  "client_id": null, // для нового клиента, или ID существующего
  "company_name": "Название компании",
  "client_type": "corporate|one_time",
  "menu_items": [...],
  "delivery_date": "2025-01-15",
  "delivery_time": "14:00"
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "order": {...},
    "application": {...},
    "client_created": true // true если создан новый клиент
  }
}
```

### Получение списка клиентов
```
GET /api/clients
```

**Фильтры:**
- `client_category`: corporate|one_time
- `status`: active|inactive|suspended
- `company_name`: поиск по названию

## Структура данных

### Модель Client
```php
fillable: [
  'name', 'email', 'password', 'phone', 'address',
  'company_name', 'position', 'contact_person',
  'client_category', 'status'
]
```

### Связи
- `Order belongsTo Client` (client_id)
- `Client hasMany Order`

## Email шаблоны

### ClientAccountCreated
- **Тема:** "Ваш аккаунт в PAUL создан"
- **Шаблон:** `resources/views/emails/client-account-created.blade.php`
- **Переменные:**
  - `$client`: данные клиента
  - `$password`: сгенерированный пароль
  - `$loginUrl`: ссылка на страницу входа

## Безопасность

- Пароли генерируются автоматически (10 символов)
- Email отправляется только новым клиентам
- Существующие клиенты не получают повторных уведомлений
- Все действия логируются

## Тестирование

### 1. Создание заявки
```bash
curl -X POST http://localhost:8000/api/applications \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "Иван",
    "last_name": "Иванов",
    "email": "ivan@example.com",
    "phone": "+7(999)123-45-67"
  }'
```

### 2. Создание заказа (создаст клиента)
```bash
curl -X POST http://localhost:8000/api/applications/1/create-order \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "company_name": "Ромашка ООО",
    "client_type": "corporate",
    "menu_items": [{"id": "1", "name": "Пицца", "quantity": 2, "price": 500}]
  }'
```

### 3. Проверка клиента
```bash
curl -X GET http://localhost:8000/api/clients \
  -H "Authorization: Bearer {token}"
```

## Дальнейшие улучшения

1. **Шаблоны email для разных типов клиентов**
2. **Интеграция с платежными системами**
3. **SMS уведомления**
4. **Персонализация кабинета клиента**
5. **История заказов и статусов**
