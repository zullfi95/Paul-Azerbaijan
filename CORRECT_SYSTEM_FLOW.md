# Правильная логика системы Paul Catering

## Роли и их функции

### Клиенты (Clients)
- **Корпоративные клиенты** (`corporate`)
- **Разовые клиенты** (`one_time`)

**Что могут делать клиенты:**
1. ✅ Создавать ЗАЯВКИ через страницу кейтеринга `/catering/order`
2. ✅ Просматривать свои заявки в профиле
3. ❌ НЕ могут создавать заказы напрямую

### Координаторы (Coordinators)
**Что могут делать координаторы:**
1. ✅ Просматривать все заявки на дашборде
2. ✅ Изменять статусы заявок (`new` → `processing` → `approved`/`rejected`)
3. ✅ Создавать ЗАКАЗЫ на основе заявок
4. ✅ Создавать новые заказы с нуля
5. ✅ Управлять всеми заказами (просмотр, редактирование, удаление)

---

## Workflow системы

### 1️⃣ Клиент создает заявку

**Страница:** `/catering/order` (CheckoutPage)

**Процесс:**
1. Клиент выбирает блюда в `/catering`
2. Переходит на страницу оформления `/catering/order`
3. Заполняет форму:
   - Личные данные (имя, фамилия, email, телефон)
   - Адрес доставки
   - Дата и время доставки
   - Дополнительные заметки
   - Дополнительные предметы (ножи, вилки, салфетки)
4. Нажимает "Submit Application"
5. **Создается ЗАЯВКА** (не заказ!)

**API endpoint:** `POST /api/applications`

**Данные заявки:**
```javascript
{
  first_name: string,
  last_name: string,
  email: string,
  phone: string,
  message: string,
  event_address: string,
  event_date: string,
  event_time: string,
  cart_items: [{
    id: string,
    name: string,
    quantity: number,
    price: number
  }],
  delivery_type: 'delivery' | 'pickup',
  additional_items: {
    knife: boolean,
    spoon: boolean,
    forks: boolean,
    napkins: boolean
  }
}
```

**Результат:**
- Заявка сохраняется со статусом `new`
- Автоматически привязывается к клиенту (`client_id`)
- Клиент видит сообщение: "Your application has been successfully submitted. Our team will contact you soon."

---

### 2️⃣ Заявка попадает на дашборд координатора

**Страница:** `/dashboard/applications`

**Что видит координатор:**
- Список всех заявок
- Фильтры по статусу (`new`, `processing`, `approved`, `rejected`)
- Детали каждой заявки:
  - Данные клиента
  - Список блюд из корзины
  - Дата и время события
  - Адрес доставки
  - Дополнительные заметки

---

### 3️⃣ Координатор создает заказ на основе заявки

**Процесс:**
1. Координатор открывает заявку
2. Просматривает детали
3. Нажимает кнопку **"Создать заказ"**
4. Система переводит на страницу создания заказа с предзаполненными данными
5. Координатор может:
   - Изменить состав заказа
   - Добавить скидки
   - Указать дополнительные параметры
6. Сохраняет заказ

**API endpoint:** `POST /api/applications/{id}/create-order`

**Результат:**
- Создается ЗАКАЗ со статусом `submitted`
- Заявка получает статус `approved`
- Заявка привязывается к заказу
- Клиент получает уведомление

---

### 4️⃣ Координатор создает заказ с нуля

**Страница:** `/dashboard/orders/create`

**Процесс:**
1. Координатор переходит на страницу создания заказа
2. Выбирает клиента (или создает нового)
3. Добавляет блюда
4. Заполняет детали заказа
5. Сохраняет

**API endpoint:** `POST /api/orders`

**Требования:**
- Должен быть координатором
- Обязательно указать `client_id`

---

## API Endpoints и права доступа

### Заявки (Applications)

| Метод | Endpoint | Доступ | Описание |
|-------|----------|--------|----------|
| POST | `/api/applications` | Все авторизованные | Создание заявки |
| GET | `/api/applications` | Координаторы | Список всех заявок |
| GET | `/api/applications/{id}` | Координаторы | Просмотр заявки |
| PATCH | `/api/applications/{id}/status` | Координаторы | Изменение статуса |

### Заказы (Orders)

| Метод | Endpoint | Доступ | Описание |
|-------|----------|--------|----------|
| GET | `/api/orders` | Координаторы | Список заказов |
| POST | `/api/orders` | **Только координаторы** | Создание заказа |
| GET | `/api/orders/{id}` | Координаторы | Просмотр заказа |
| PUT | `/api/orders/{id}` | Координаторы | Обновление заказа |
| DELETE | `/api/orders/{id}` | Координаторы | Удаление заказа |
| POST | `/api/applications/{id}/create-order` | Координаторы | Создание заказа из заявки |

### Заказы клиента

| Метод | Endpoint | Доступ | Описание |
|-------|----------|--------|----------|
| GET | `/api/client/orders` | Клиенты | Все заказы клиента |
| GET | `/api/client/orders/active` | Клиенты | Активные заказы |
| GET | `/api/client/orders/{id}` | Клиенты | Просмотр своего заказа |

---

## Важные изменения

### ✅ Исправлено:
1. **CheckoutPage теперь создает заявки**, а не заказы
2. **API endpoint изменен** с `/api/orders` на `/api/applications`
3. **Структура данных** соответствует формату заявок
4. **Права доступа** восстановлены: только координаторы могут создавать заказы

### ❌ Было неправильно:
1. CheckoutPage создавал заказы напрямую
2. Клиенты имели доступ к endpoint `/api/orders`
3. Нарушался workflow: клиент → заявка → координатор → заказ

---

## Статусы

### Статусы заявок:
- `new` - Новая заявка
- `processing` - В обработке
- `approved` - Одобрена (создан заказ)
- `rejected` - Отклонена

### Статусы заказов:
- `draft` - Черновик
- `submitted` - Отправлен
- `processing` - В обработке
- `completed` - Завершен
- `cancelled` - Отменен

---

## Уведомления

### При создании заявки:
- Клиент получает подтверждение
- Координаторы получают уведомление о новой заявке

### При изменении статуса заявки:
- Клиент получает уведомление об изменении

### При создании заказа:
- Клиент получает уведомление о создании заказа
- Координаторы получают уведомление

---

## Резюме

**Правильный flow:**
```
Клиент → Выбирает блюда → Оформляет заявку → 
Заявка на дашборде координатора → 
Координатор создает заказ → 
Заказ обрабатывается
```

**Неправильный flow (было):**
```
Клиент → Выбирает блюда → Создает заказ напрямую ❌
```

Теперь система работает согласно бизнес-логике!

