# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏ 500 –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "Complete Payment" –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ 500 (Internal Server Error) –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### ‚úÖ **–õ–æ–≥–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:**
```
Creating payment for order: 13
Auth token exists: true
Payment response status: 500
Payment error response: {}
```

### ‚úÖ **–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ 500:**
1. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö** - –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω
2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å AlgoritmaService** - –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API
3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏
4. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –∫–ª–∏–µ–Ω—Ç–∞** - –Ω–µ `one_time`
5. **–ü—Ä–æ–±–ª–µ–º–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –∑–∞–∫–∞–∑–∞** - –Ω–µ `submitted` –∏–ª–∏ `payment_status` –Ω–µ `pending`

## ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**

### 1. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ PaymentController**

**–ù–æ–≤—ã–µ –ª–æ–≥–∏:**
```php
// –ù–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞
Log::info('PaymentController::createPayment called', [
    'order_id' => $order->id,
    'user_id' => $request->user()?->id,
    'user_type' => $request->user()?->user_type,
    'user_status' => $request->user()?->status,
]);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
Log::warning('Payment authorization failed', [
    'user_exists' => !!$user,
    'user_active' => $user ? $user->isActive() : false,
    'user_status' => $user ? $user->status : null,
]);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
Log::info('Checking payment access rights', [
    'user_type' => $user->user_type,
    'user_role' => $user->staff_role,
    'is_coordinator' => $user->isCoordinator(),
    'is_client' => $user->isClient(),
    'order_client_id' => $order->client_id,
    'user_id' => $user->id,
]);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
Log::info('Checking client category for payment', [
    'client_exists' => !!$client,
    'client_category' => $client ? $client->client_category : null,
    'order_client_id' => $order->client_id,
]);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
Log::info('Checking order payment status', [
    'order_status' => $order->status,
    'payment_status' => $order->payment_status,
    'can_pay' => $order->isPendingPayment(),
]);

// –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ Algoritma
Log::info('Creating Algoritma order', [
    'order_data' => $orderData,
]);

Log::info('Algoritma order creation result', [
    'success' => $result['success'] ?? false,
    'order_id' => $result['order_id'] ?? null,
    'payment_url' => $result['payment_url'] ?? null,
    'error' => $result['error'] ?? null,
]);
```

### 2. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ frontend**

**–ù–æ–≤—ã–µ –ª–æ–≥–∏:**
```typescript
console.log('Creating payment for order:', orderId);
console.log('Auth token exists:', !!token);
console.log('User data:', user);
console.log('User type:', user?.user_type);
console.log('User status:', user?.status);
console.log('User client category:', user?.client_category);
console.log('Payment response status:', response.status);
console.log('Payment response data:', data);
console.error('Payment error response:', errorData);
```

## üîß **–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏**

### **1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Laravel:**
```bash
cd backend
tail -f storage/logs/laravel.log
```

### **2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
- `user_type` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `'client'` –∏–ª–∏ `'staff'`
- `status` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `'active'`
- `client_category` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `'one_time'` –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

### **3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:**
- `status` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `'submitted'`
- `payment_status` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `'pending'` –∏–ª–∏ `null`
- `client_id` –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### **4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –ª—é–±—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- –ö–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö –∑–∞–∫–∞–∑–æ–≤

## üéØ **–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è**

### **1. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π:**
```php
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω
if (!$user || !$user->isActive()) {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
}
```

### **2. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞:**
```php
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
if ($user->isCoordinator()) {
    $hasAccess = true;
} elseif ($user->isClient() && $order->client_id === $user->id) {
    $hasAccess = true;
}
```

### **3. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –∫–ª–∏–µ–Ω—Ç–∞:**
```php
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–ª–∏–µ–Ω—Ç–∞
if (!$client || $client->client_category !== 'one_time') {
    // –ö–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –æ–ø–ª–∞—á–∏–≤–∞—Ç—å
}
```

### **4. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –∑–∞–∫–∞–∑–∞:**
```php
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
if (!$order->isPendingPayment()) {
    // –ó–∞–∫–∞–∑ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–ª–∞—á–µ–Ω
}
```

## üìä **–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏**

### **–£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂:**
```
PaymentController::createPayment called
Checking payment access rights
Checking client category for payment
Checking order payment status
Creating Algoritma order
Algoritma order creation result
Payment created successfully
```

### **–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
```
Payment authorization failed
```

### **–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:**
```
Payment access denied
```

### **–û—à–∏–±–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞:**
```
Payment denied - client category check failed
```

### **–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞:**
```
Payment denied - order status check failed
```

## üîÑ **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**

### **1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
- –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä Laravel
- –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ `storage/logs/laravel.log`

### **2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:**
- –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–ª–∏–µ–Ω—Ç–∞
- –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

### **3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:**
- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
- –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## üéØ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

### ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
- üîç **–¢–æ—á–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞** –æ—à–∏–±–∫–∏
- üìä **–ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- üéØ **–ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –ø—Ä–æ–±–ª–µ–º
- üì± **–õ—É—á—à–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

### ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞:**
- üîß **–õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏** –ø—Ä–æ–±–ª–µ–º—É
- üìä **–ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –∫–ª–∏–µ–Ω—Ç–µ
- üéØ **–¢–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** –æ–± –æ—à–∏–±–∫–∞—Ö
- üì± **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

–û—à–∏–±–∫–∞ 500 —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏! üéâ

